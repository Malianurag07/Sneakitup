{% extends 'products/base.html' %}
{% load static %}

{% block content %}
<style>
    /* --- 1. LAYOUT: FIXED PERCENTAGE HEIGHT --- */
    /* This forces the window to be open to 75% of your screen height. */
    /* This prevents the "0 height" invisible bug. */
    .customizer-wrapper {
        display: flex;
        flex-wrap: wrap;
        height: 80vh; 
        width: 100%;
        border-bottom: 4px solid #4B0082;
        border-top: 1px solid #333;
        background: #000;
        overflow: hidden;
    }

    /* --- 2. SIDEBAR CONFIGURATION --- */
    .controls-panel {
        width: 320px;
        height: 100%;
        background: #1a1a1a;
        color: white;
        padding: 20px;
        border-right: 2px solid #333;
        
        /* FIX: Include padding in the height calculation so it doesn't overflow */
        box-sizing: border-box;

        /* Stack items vertically: Header -> List -> Button */
        display: flex;
        flex-direction: column; 
    }

    /* Header */
    .controls-panel h3 {
        font-family: 'Bangers', cursive;
        color: #ffae00;
        letter-spacing: 1.5px;
        font-size: 1.8rem;
        text-align: center;
        margin-bottom: 5px;
        text-transform: uppercase;
        flex-shrink: 0;
    }

    .controls-panel p {
        text-align: center;
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 15px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        flex-shrink: 0;
    }

    /* --- 3. SCROLLING LIST --- */
    /* This part takes all available space in the middle */
    #controls-list {
        flex-grow: 1; 
        overflow-y: auto; /* Only this middle part scrolls */
        margin-bottom: 15px; 
        padding-right: 5px; 
    }

    /* Scrollbar Styling */
    #controls-list::-webkit-scrollbar { width: 8px; }
    #controls-list::-webkit-scrollbar-track { background: #1a1a1a; }
    #controls-list::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    #controls-list::-webkit-scrollbar-thumb:hover { background: #ffae00; }

    /* Control Item Styling */
    .control-item {
        background: #2a2a2a;
        padding: 10px 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #333;
        transition: 0.2s;
        margin-bottom: 10px;
    }
    .control-item:hover {
        border-color: #ffae00;
        background: #333;
    }
    .control-item label {
        font-family: 'Merriweather', serif;
        font-size: 0.9rem;
        margin: 0;
        font-weight: bold;
        color: #e0e0e0;
    }
    input[type="color"] {
        border: none;
        width: 40px;
        height: 40px;
        cursor: pointer;
        background: none;
        padding: 0;
    }

    /* --- 4. FIXED DOWNLOAD BUTTON --- */
    /* Pinned to the bottom, never disappears */
    #save-btn {
        flex-shrink: 0; 
        background: #ffae00;
        border: none;
        padding: 15px;
        font-weight: bold;
        font-family: 'Bangers';
        font-size: 1.2rem;
        cursor: pointer;
        border-radius: 5px;
        width: 100%;
        transition: 0.3s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    /* --- 5. CANVAS AREA --- */
    #canvas-container {
        flex: 1; /* Fills remaining width */
        height: 100%; /* Fills 100% of the wrapper height */
        background-color: #f0f0f0;
        position: relative;
        overflow: hidden;
    }
     
    #loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #333;
        font-weight: bold;
        background: rgba(255,255,255,0.9);
        padding: 15px 30px;
        border-radius: 50px;
        z-index: 10;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* Footer Override */
    footer {
        margin-top: 0 !important;
    }
</style>

<div class="customizer-wrapper">
    <div class="controls-panel">
        <h3>Design Studio</h3>
        <p>Customize your exclusive kicks.</p>
        
        <div id="controls-list">
            </div>
        
        <button id="save-btn" onclick="downloadDesign()">
            DOWNLOAD DESIGN ðŸ“¸
        </button>
    </div>

    <div id="canvas-container">
        <div id="loader">Loading Shoe...</div>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

    // --- CONFIGURATION ---
    const partLabels = {
        'shoe': 'Laces',
        'shoe_1': 'Main Body',
        'shoe_2': 'Eyelets (Lace Holes)',
        'shoe_3': 'Inner Lining',
        'shoe_4': 'Sole',
        'shoe_5': 'Side Stripes',
        'shoe_6': 'Tongue Loop',
        'shoe_7': 'Heel Patch'
    };

    // --- SETUP ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xe0e0e0);

    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(2, 1.5, 2.5);

    const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    container.appendChild(renderer.domElement);

    // --- LIGHTING ---
    const ambientLight = new THREE.AmbientLight(0xffffff, 1);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
    dirLight.position.set(5, 10, 7);
    scene.add(dirLight);
    const backLight = new THREE.DirectionalLight(0xffffff, 0.8);
    backLight.position.set(-5, 5, -5);
    scene.add(backLight);

    // --- CONTROLS ---
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // --- LOGIC: CHANGE COLOR ---
    window.updateColor = function(partName, colorValue) {
        scene.traverse((child) => {
            if (child.isMesh && child.name === partName) {
                const newMat = child.material.clone();
                newMat.color.set(colorValue);
                child.material = newMat;
            }
        });
    };

    // --- LOGIC: DOWNLOAD SCREENSHOT ---
    window.downloadDesign = function() {
        const btn = document.getElementById('save-btn');
        const oldText = btn.innerText;
        btn.innerText = "CAPTURING...";
        btn.style.background = "#fff";
        
        renderer.render(scene, camera);
        const imgData = renderer.domElement.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = 'my-sneakitup-design.png';
        link.href = imgData;
        link.click();

        setTimeout(() => { 
            btn.innerText = oldText; 
            btn.style.background = "#ffae00";
        }, 1000);
    };

    // --- LOADER ---
    const dracoLoader = new DRACOLoader();
    dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');

    const loader = new GLTFLoader();
    loader.setDRACOLoader(dracoLoader);
    
    const modelPath = "{% static '3d_models/shoe.glb' %}";

    loader.load(modelPath, function (gltf) {
        const shoe = gltf.scene;
        
        const box = new THREE.Box3().setFromObject(shoe);
        const center = box.getCenter(new THREE.Vector3());
        shoe.position.sub(center);
        shoe.rotation.y = -Math.PI / 4;

        scene.add(shoe);
        document.getElementById('loader').style.display = 'none';

        // --- GENERATE CONTROLS ---
        const controlsList = document.getElementById('controls-list');
        const foundParts = [];

        shoe.traverse((child) => {
            if (child.isMesh) {
                if (!foundParts.includes(child.name)) {
                    foundParts.push(child.name);
                    const displayName = partLabels[child.name] || child.name;

                    const div = document.createElement('div');
                    div.className = 'control-item';
                    
                    let initialColor = "#ffffff";
                    if (child.material && child.material.color) {
                         initialColor = "#" + child.material.color.getHexString();
                    }

                    div.innerHTML = `
                        <label>${displayName}</label>
                        <input type="color" value="${initialColor}" oninput="updateColor('${child.name}', this.value)">
                    `;
                    controlsList.appendChild(div);
                }
            }
        });

    }, undefined, function (error) {
        console.error(error);
        document.getElementById('loader').innerText = "Error loading model.";
    });

    // --- ANIMATION ---
    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
</script>
{% endblock %}